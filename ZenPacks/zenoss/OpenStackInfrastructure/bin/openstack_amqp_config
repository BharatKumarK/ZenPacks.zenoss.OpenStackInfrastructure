#!/bin/sh

AMQP_USERID="openstack"
AMQP_PASSWORD="[previously configured password]"
AMQP_HOSTNAME=`zenglobalconf -p amqphost`
AMQP_PORT=`zenglobalconf -p amqpport`
AMQP_VIRTUAL_HOST=`zenglobalconf -p amqpvhost`

echo "RabbitMQ Configuration"
echo "--------------------"
sudo rabbitmqctl list_users | grep $AMQP_USERID > /dev/null
if [ "$?" = "0" ]; then
   echo "User '$AMQP_USERID' already exists in rabbitmq.  Leaving existing password in place."
   echo "If you need to change the password, use the following command:"
   echo "   sudo rabbitmqctl change_password -p $AMQP_VIRTUAL_HOST $AMQP_USERID [newpassword]"
   echo ""
else
   AMQP_PASSWORD=`openssl rand -base64 15`

   echo "Adding user '$AMQP_USERID' user to rabbitmq"
   sudo rabbitmqctl add_user "$AMQP_USERID" "$AMQP_PASSWORD"
fi

# Ensure that openstack user has appropriate permissions
sudo rabbitmqctl clear_permissions -p "$AMQP_VIRTUAL_HOST" "$AMQP_USERID"
sudo rabbitmqctl set_permissions -p "$AMQP_VIRTUAL_HOST" "$AMQP_USERID" '' '' 'zenoss.openstack.*'

echo ""
echo "OpenStack Configuration"
echo "-----------------------"
echo "Add the following configuration to ceilometer.conf on all openstack nodes:"
echo ""
echo "    [DEFAULT]"
echo "    dispatcher=zenoss"
echo "" 
echo "    [notification]"
echo "    store_events=True"
echo ""
echo "    [dispatcher_zenoss]"
echo "    "
echo "    zenoss_device = [device that the openstack environment is registered as in zenoss]"
echo "    "
echo "    amqp_hostname = $AMQP_HOSTNAME"
echo "    amqp_port = $AMQP_PORT"
echo "    amqp_userid = $AMQP_USERID"
echo "    amqp_password = $AMQP_PASSWORD"
echo "    amqp_virtual_host = $AMQP_VIRTUAL_HOST"

case "$AMQP_HOSTNAME" in 
	localhost* | 127.0.0* )
		echo ""
		echo ""
		echo "WARNING: amqp_hostname appears to be localhost- you will need to"
		echo "         specify a different IP so that your openstack environment"
		echo "         can reach rabbitmq from the outside."
		;;
esac